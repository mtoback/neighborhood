function initialize(){"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(position){lat=position.coords.latitude,lng=position.coords.longitude,viewModel.weather(lat,lng);var mapProp={center:new google.maps.LatLng(lat,lng),zoom:viewModel.zoom(),mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("googleMap"),mapProp),initYelp(viewModel,map)},function(){alert("This browser does not have geolocation on. Using default location instead."),$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?address="+viewModel.location()}).done(function(result){lat=result.results[0].geometry.location.lat,lng=result.results[0].geometry.location.lng,viewModel.weather(lat,lng);var mapProp={center:new google.maps.LatLng(lat,lng),zoom:viewModel.zoom(),mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("googleMap"),mapProp),initYelp(viewModel,map)}).fail(function(xhr,ajaxOptions,thrownError){404===xhr.status?alert("internet failure occurred. Please check your connection"):alert("unknown error occurred... status = "+xhr.status)})}):$.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json?address="+viewModel.location()}).done(function(result){lat=result.results[0].geometry.location.lat,lng=result.results[0].geometry.location.lng,viewModel.weather(lat,lng);var mapProp={center:new google.maps.LatLng(lat,lng),zoom:viewModel.zoom(),mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("googleMap"),mapProp),initYelp(viewModel,map)}).fail(function(xhr,ajaxOptions,thrownError){404===xhr.status?alert("internet failure occurred. Please check your connection"):alert("unknown error occurred... status = "+xhr.status)})}function initYelp(viewModel,map){var auth={consumerKey:"IuMIJl585jfMDHz7spOj3w",consumerSecret:"8qnDc0yEa59ZHfXN1uM3XY-RcW4",accessToken:"bfEYLApv2Hxfs0vDEh6TMRsOllsGYEG1",accessTokenSecret:"zcavaTCQX2wlPIjvm4DqUzzGV94",serviceProvider:{signatureMethod:"HMAC-SHA1"}},parameters=({consumerSecret:auth.consumerSecret,tokenSecret:auth.accessTokenSecret},{oauth_consumer_key:auth.consumerKey,oauth_token:auth.accessToken,oauth_nonce:nonceGenerate(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",term:"restaurant",location:"Saratoga CA",radius_filter:viewModel.radiusFilter()}),yelp_url="https://api.yelp.com/v2/search",encodedSignature=oauthSignature.generate("GET",yelp_url,parameters,"8qnDc0yEa59ZHfXN1uM3XY-RcW4","zcavaTCQX2wlPIjvm4DqUzzGV94");parameters.oauth_signature=encodedSignature,$.ajax({url:yelp_url,data:parameters,cache:!0,dataType:"jsonp",success:function(results){var businesses=results.businesses;businesses.forEach(function(business){function toggleBounce(){if("undefined"!=typeof viewModel.currentMarker()){var aMarker=viewModel.currentMarker();if(aMarker.title===marker.title)return;null!==aMarker.getAnimation()&&aMarker.setAnimation(null)}viewModel.currentMarker(marker),"undefined"!=typeof infowindow&&infowindow.close(),infowindow=new google.maps.InfoWindow({content:'<a target="_blank" href="'+marker.url+'">'+marker.title+"</a><span>&nbsp;"+marker.categories+"</span>"}),infowindow.open(map,marker),marker.setAnimation(google.maps.Animation.BOUNCE)}var name=business.name,url=business.mobile_url,categories=[];business.categories.forEach(function(category){categories.push(category[0])});var lat=business.location.coordinate.latitude,lng=business.location.coordinate.longitude,myLatlng=new google.maps.LatLng(lat,lng),marker=new google.maps.Marker({position:myLatlng,animation:google.maps.Animation.DROP,title:name,url:url,categories:categories.join(", ")});viewModel.markers.push(marker),viewModel.displayMarkers.push(marker),marker.addListener("click",toggleBounce),marker.setMap(map)}),businesses.length>0&&$("#search").show()},error:function(xhr,ajaxOptions,thrownError){404===xhr.status?alert("internet failure occurred on Yelp API. Please check your connection"):alert("unknown error occurred on Yelp API... status = "+xhr.status)}})}function googleError(){alert("google map did not load due to unknown error")}function nonceGenerate(){return Math.floor(1e12*Math.random()).toString()}function setMapOnAll(map,markers){for(var i=0;i<markers.length;i++)markers[i].setMap(map)}var map,infowindow,ViewModel=function(){this.location=ko.observable("18764 Cox Ave, Saratoga CA"),this.searches=ko.observableArray(["Post Office","Restaurant","Grocery Stores"]),this.markers=ko.observableArray(),this.displayMarkers=ko.observableArray(),this.currentMarker=ko.observable(),this.searchTag=ko.observable(),this.localWeather=ko.observable(),this.filter=ko.observable(""),this.zoom=ko.observable(12)};ViewModel.prototype.updateMarker=function(marker){if("undefined"!=typeof viewModel.currentMarker()){var aMarker=viewModel.currentMarker();if(aMarker.title===marker.title)return;null!==aMarker.getAnimation()&&aMarker.setAnimation(null)}viewModel.currentMarker(marker),"undefined"!=typeof infowindow&&infowindow.close(),infowindow=new google.maps.InfoWindow({content:'<a target="_blank" href="'+marker.url+'">'+marker.title+"</a><span>&nbsp;"+marker.categories+"</span>"}),infowindow.open(map,marker),marker.setAnimation(google.maps.Animation.BOUNCE)},this.ViewModel.prototype.filterMap=function(){if("undefined"!=typeof viewModel.currentMarker()){var marker=viewModel.currentMarker();null!==marker.getAnimation()&&marker.setAnimation(null)}var filter=viewModel.filter().toLowerCase();if(viewModel.markers().length>0){setMapOnAll(null,viewModel.displayMarkers()),viewModel.displayMarkers.removeAll();for(var i=0;i<viewModel.markers().length;i++)viewModel.markers()[i].title.toLowerCase().indexOf(filter)>-1&&viewModel.displayMarkers.push(viewModel.markers()[i]);setMapOnAll(map,viewModel.displayMarkers())}},ViewModel.prototype.weather=function(lat,lng){$.ajax({url:"http://maps.googleapis.com/maps/api/geocode/json?latlng="+lat+","+lng+"&sensor=true"}).done(function(result){for(var components=result.results[0].address_components,len=components.length,foundCity=!1,foundState=!1,city="",state="",i=0;len>i&&(!foundCity||!foundState);i++){var component=components[i];"locality"===component.types[0]?(city=component.long_name,foundCity=!0):"administrative_area_level_1"===component.types[0]&&(state=component.short_name,found_state=!0)}$.ajax({url:"http://api.wunderground.com/api/421920ddc8bd7347/forecast/q/"+state+"/"+city+".json"}).done(function(result){var forecast=result.forecast.simpleforecast.forecastday[0],temp=forecast.low.fahrenheit+"-"+forecast.high.fahrenheit,conditions=forecast.conditions;viewModel.localWeather(conditions+":"+temp)}).fail(function(xhr,ajaxOptions,thrownError){404===xhr.status?alert("internet failure occurred on weather API. Please check your connection"):alert("unknown error occurred on weather API... status = "+xhr.status)})}).fail(function(xhr,ajaxOptions,thrownError){404===xhr.status?alert("internet failure occurred on Google Map API. Please check your connection"):alert("unknown error occurred on Google Map API... status = "+xhr.status)})};var viewModel=new ViewModel;viewModel.filter.subscribe(viewModel.filterMap),viewModel.radiusFilter=ko.computed(function(){return 11===this.zoom()?4e4:12===this.zoom()?2e4:(13===this.zoom(),1e4)},viewModel),ko.applyBindings(viewModel);